<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Snap.svg js - Bubles</title>
    <style>
        html, body {width: 100%; height: 100%; margin: 0;}
        button {position: absolute; right: 1rem; z-index: 10;}
        .up {top: 1rem;}
        .dwn {top: 3rem;}
        .chart {
            transform-origin: 50% 50%; /* center of rotation is set to the center of the element */
            transform: scale(1,-1);
        }
        .chart > g {
            transform: scaleY(-1);
        }
    </style>
</head>

<body>
    <button class='up'>up</button>
    <button class='dwn'>dwn</button>
    <svg class="chart"></svg>
    <script src="js/snap.svg-min.js"></script>
    <script src="js/snap-rapineda-text.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded',function(){
            const data = [
                {
                    id: 0,
                    color: '#008080',
                    text: 'Root element',
                    children: [1, 2]
                },
                {
                    id: 1,
                    color: '#ff4000',
                    text: 'Element 1 - some longer title',
                    children: [3, 4, 5],
                    parent: 0
                },
                {
                    id: 2,
                    color: '#ffbf00',
                    text: 'Element 2',
                    children: [6, 7],
                    parent: 0
                },
                {
                    id: 3,
                    color: '#00ffff',
                    children: [],
                    text: 'Element 1.1',
                    parent: 1
                },
                {
                    id: 4,
                    color: '#bfff00',
                    text: 'Element 1.2',
                    children: [],
                    parent: 1
                },
                {
                    id: 5,
                    color: '#80ff00',
                    children: [],
                    text: 'Element 1.3',
                    parent: 1
                },
                {
                    id: 6,
                    color: '#40ff00',
                    children: [],
                    text: 'Element 2.1',
                    parent: 2
                },
                {
                    id: 7,
                    color: '#8000ff',
                    text: 'Element 2.2',
                    children: [],
                    parent: 2
                },
            ];

            let width = window.innerWidth, height = window.innerHeight;
            let startX = 900;
            let startY = -height/2;
            let viewBox = startX + " " + startY + " " + width + " " + height;
            let chart = Snap('.chart');
            chart.attr({viewBox:viewBox, height: height, width: width});

            let curentElement = 0;
            let changeMarker = false;
            const setCurrentElement = (index) => {
                if (index !== curentElement) {
                    curentElement = index;
                    changeMarker = true;
                } else if (curentElement !== 0){
                    curentElement = data[curentElement].parent;
                    changeMarker = true;
                } else {
                    curentElement = 0;
                }
            }

            const addActiveElement = (element) => {
                let activeCircle = chart.circle(0, 0, 1000);
                activeCircle.attr({
                    fill: element.color
                });
                activeCircle.click(() => {
                    setCurrentElement(element.id)
                    redraw();
                });
            }

            const childPosition = (index, radius, step, offset) => {
                let theta = Math.PI / 2 - index * step * Math.PI / 180 - offset * Math.PI / 180;
                return {
                    x: radius * Math.sin(theta),
                    y: radius * Math.cos(theta)
                }
            }

            let childElements = [];
            const addChildElement = (element, index) => {
                let childCircle = chart.circle(childPosition(index, 1150, 10, -10).x, childPosition(index, 1150, 10, -10).y, 75);
                let childText = chart.text(childPosition(index, 1150, 10, -10).x, childPosition(index, 1150, 10, -10).y, element.text).wrap(75);
                childCircle.attr({
                    fill: element.color
                });
                childText.attr({
                    "text-anchor":"middle",
                    'font-size': 20
                });
                var t = new Snap.Matrix()
                t.translate(0, -childText.getBBox().h/2 + 20);
                childText.transform(t);
                childElements[index] = chart.group(childCircle, childText);
                childElements[index].click(() => {
                    setCurrentElement(element.id);
                    redraw();
                });
            }

            const setScene = (element) => {
                addActiveElement(element);
                element.children.forEach((child, index) => {
                    addChildElement(data[child], index);
                });
                changeMarker = false;
            };

            const redraw = () => {
                chart.clear();
                setScene(data[curentElement]);
            }

            let currentCameraAngle = 0;

            setScene(data[0]);
            document.querySelector('.up').addEventListener('click', () => {
                const step = 1 * Math.PI / 180;
                currentCameraAngle += step;
                startX = 900 * Math.cos(currentCameraAngle);
                startY = 900 * Math.sin(currentCameraAngle) -height/2;
                viewBox = startX + " " + startY + " " + width + " " + height;
                chart.attr("viewBox", viewBox);
            });

            document.querySelector('.dwn').addEventListener('click', () => {
                const step = 1 * Math.PI / 180;
                currentCameraAngle -= step;
                startX = 900 * Math.cos(currentCameraAngle);
                startY = 900 * Math.sin(currentCameraAngle) -height/2;
                viewBox = startX + " " + startY + " " + width + " " + height;
                chart.attr("viewBox", viewBox);
            })

        });
    </script>
</body>

</html>
